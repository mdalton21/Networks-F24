---
title: "Final Project Update"
author: "Maya Dalton"
output: pdf_document
date: "October 22, 2024"
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Visualization and Replication of Colby (2021) 

The data for my final project replication and extension are from Colby, Darren, 2021, "Chaos from Order: A Network Analysis of In-fighting Before and After El Chapo's Arrest". [link](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/L4AXQT)

The replication materials, including the data and R scripts for analysis can be found [here](https://github.com/mdalton21/Networks-F24/tree/main). 

```{r, message=FALSE, warning=FALSE, results='hide'}
## libraries
libs <- c("dplyr", "tidyverse", "RColorBrewer", "network", "igraph", "sna", "ggraph", 
          "blockmodeling", "RSiena", "texreg")
sapply(libs, require, character.only = TRUE)

## paths
args <- commandArgs(trailingOnly = TRUE)
root <- ifelse(length(args) == 0, file.path(".."), args)
dat_dir <- file.path(root, "data")
#fig_dir <- file.path(root, "figures")
scr_dir <- file.path(root, "scripts")
#tab_dir <- file.path(root, "tables")

color <- brewer.pal(4, "RdBu") # choosing a specific palette
```

```{r, message=FALSE}
## Load in dataset ----------------------------------------
drugnet <- read_csv(file.path(dat_dir, "drugnet.csv"))
```

```{r}
## Initializing network objects ----------------------------------------
edge_df <- drugnet %>% # Create edge list
   select(sideA, sideB, weight) 

combined_graph <- graph_from_data_frame(edge_df) # turn into igraph

combined_matrix <- as.matrix(as_adjacency_matrix(combined_graph)) # adjacency matriz

main_graph <- edge_df %>% # distinct observations for igraph
   distinct(sideA, sideB) %>% 
   graph_from_data_frame()
```

```{r, message=FALSE, results='hide'}
## Add structural equivalence group attribute ------------------------------
# Create a 7 block solution
blocks <- optRandomParC(M = combined_matrix, 
                        k = 7,  
                        rep = 100,  
                        approaches = "ss", 
                        blocks = "com",  
                        seed = 42)

# Assign actors to blocks
V(main_graph)$role <- blocks$best$best1$clu

# Convert roles to names
V(main_graph)$role <- case_when(
   V(main_graph)$role == 1 ~ "Gulf Cartel",
   V(main_graph)$role == 2 ~ "Rising Challengers",
   V(main_graph)$role == 3 ~ "Sinaloa Cartel",
   V(main_graph)$role == 4 ~ "Small Cartels and Militias",
   V(main_graph)$role == 5 ~ "Los Zetas",
   V(main_graph)$role == 6 ~ "White Dwarfs",
   V(main_graph)$role == 7 ~ "Cartel Jalisco Nueva Generacion",
   TRUE ~ as.character(V(main_graph)$role)
)
```


```{r}
## Add attribute for militia status ----------------------------------------
# List of militia groups from replication code
militias <- c("malinaltepec communal militia (mexico)", "chamula militia", 
              "san pablo cuatro venados communal militia (mexico)", 
              "dzan communal militia (mexico)", 
              "el pinar communal militia (mexico)", 
              "loma de la cruz communal militia (mexico)", 
              "molinos los arcos communal militia (mexico)", 
              "el carrizal de bravo communal militia (mexico)", 
              "huahua communal militia (mexico)", 
              "tlacotepec communal militia (mexico)", 
              "maya indigenous militia (mexico)", 
              "mixe indigenous militia (mexico)", 
              "san agustin oapan communal militia (mexico)", 
              "santa isabel de la reforma communal militia (mexico)", 
              "aldama indigenous militia (mexico)", 
              "san mateo yucutindoo communal militia (mexico)", 
              "apetlanca communal militia (mexico)", 
              "rio santiago communal militia (mexico)",
              "yautepec communal militia (mexico)", 
              "upoeg self defense group", 
              "faction of front for security and development vigilante group", 
              "totolapan self-defense force", "autodefensas unidas de michoacan", 
              "alacatlatzala communal militia (mexico)", 
              "chocomanatlan communal militia (mexico)", 
              "coahuayutla de guerrero communal militia (mexico)", 
              "cotija de la paz communal militia (mexico)", 
              "cuilapam de guerrero communal militia (mexico)", 
              "el cipresal communal militia (mexico)", 
              "el nith communal militia (mexico)", 
              "ezln: zapatista army of national liberation", 
              "leonardo bravo communal militia (mexico)", 
              "los reyes communal militia (mexico)", 
              "san cristobal de las casas communal militia (mexico)", 
              "san miguel tecuiciapan communal militia (mexico)", 
              "santa maria nativitas coatlan communal militia (mexico)", 
              "santa martha indigenous militia (mexico)", 
              "santiago amoltepec communal militia (mexico)", 
              "santiago miltepec communal militia (mexico)", 
              "santo reyes zochiquilazala communal militia (mexico)", 
              "tangancicuaro communal militia (mexico)", 
              "tenquizolco communal militia (mexico)", 
              "tepalcatepec communal militia (mexico)", 
              "tinguindin communal militia (mexico)", 
              "tocumbo communal militia (mexico)", 
              "villa morelos communal militia (mexico)", 
              "villa victoria communal militia (mexico)", 
              "xochiltepec communal militia (mexico)",
              "rival faction of front for security and development vigilante group")

# Assign militia status to nodes
V(main_graph)$militia <- ifelse(V(combined_graph)$name %in% militias, 1, 0)
```

```{r}
## Add aggressiveness attribute -----------------------------------------

# Convert the graph to a dataframe
temp_vector <- as_data_frame(main_graph) %>% 
   as_tibble() %>% 
   select(from) %>% 
   
   # Merge the vertices with the the aggression data for sending actors
   left_join(drugnet %>% 
                select(sideA, agression) %>% 
                distinct(), 
             by = c("from" = "sideA")) %>% 
   distinct(from, agression) %>% 
   
   # Add the sideB actors to the dataframe. Using a full join will only add rows
   # for actors not already in the dataframe
   full_join(drugnet %>% 
                select(sideB, agression) %>% 
                distinct(),
             by = c("from" = "sideB")) %>% 
   select(-agression.y) %>% 
   rename("agression" = agression.x) %>% 
   distinct(from, agression) %>% 
   select(agression) %>% 
   
   # Codes actors that never directed an attack as having an aggression of 0
   mutate(agression = ifelse(is.na(agression), 0, agression)) %>% 
   ungroup() %>% 
   pull()

# Assign aggression scores to vertices
V(main_graph)$aggression <- temp_vector
```

```{r}
## Add subfaction attribute --------------------------------------------------
subfaction <- vector(length = 151, mode = "numeric")

# The indices of groups that are subfactions
subfaction[c(8, 72, 74, 75, 77:79, 113, 134, 136:138, 142:146, 148, 149)] <- 1
V(main_graph)$subfaction <- subfaction
```


```{r, message=FALSE}
## Create time period before and after arrest -----------------------------------
# Create a vector of periods in which each tie existed
period <- drugnet %>% 
   mutate(period = ifelse(year < 2017, 1, 2)) %>% 
   group_by(period, sideA, sideB) %>% 
   ungroup() %>% 
   distinct(sideA, sideB, period) %>% 
   group_by(sideA, sideB) %>% 
   summarise(period = max(period)) %>% 
   ungroup() %>% 
   pull(period)

# Add a year attribute to the combined graph
E(main_graph)$period <- period

# Split into two graphs for pre and post arrest
preNet <- subgraph.edges(main_graph, E(main_graph)[E(main_graph)$period < 2])

postNet <- subgraph.edges(main_graph, E(main_graph)[E(main_graph)$period > 1])
```

## Plot of the Networks
The main plots of the network can be found in Figures 1a-b below, with 1a showing the network prior to El Chapo's arrest in 2017, and 1b showing the network following his arrest. 

```{r, fig.height=4, fig.width=6}
## Plots of the Network -----------------------------------
# Before El Chapo arrest
set.seed(5)
xy_cool <- layout_with_fr(preNet)
xy <- plot(preNet, # network
           vertex.label="", # don't display the labels
           coord = xy_cool,  # set the coordinates
           vertex.color=color,
           edge.arrow.size = 0.5,
           main = "Figure 1a. Cartel Network Pre-Arrest") # color the nodes

# After El Chapo arrest
set.seed(5)
xy_cool <- layout_with_fr(postNet)
xy <- plot(postNet, # network
           vertex.label="", # don't display the labels
           coord = xy_cool,  # set the coordinates
           vertex.color=color,
           edge.arrow.size = 0.5,
           main = "Figure 1b. Cartel Network Post-Arrest") # color the nodes
```

## Vertex Attributes
Vertex attributes include group aggression, militia status, subfaction status, and role as small or large cartel group. Figure 2a shows the distribution of group aggression, with a majority of groups having lower aggression scores. Aggression is the log of the number of attacks conducted by each actor during both periods. Figure 2b shows a majority of cartels being non-militia, but still a decent amount being militia groups. Figure 2c shows that most groups are not subfactions of larger groups, but instead independent organizations. 

Figure 2d shows the distribution of cartel roles. The most powerful cartels -- the Gulf, Jalisco Nueva Generacion (NG), Los Zetas, and Sinaloa cartels are less frequent roles. Small cartels and militias that control small swaths
of territory are the most frequent roles. These cartels tend to specialize in a small number of subtasks of drug trafficking and align themselves with larger cartels. There are a smaller amount of Rising Challengers, which are relatively new cartels that are rapidly growing. Finally, the White Dwarfs represent cartels that are on the decline.

Figure 2e shows the count of cartel groups in time period 1 (pre-2017 arrest) and 2 (post-2017 arrest). There are many more cartels in the second time period. 

```{r, fig.height=4, fig.width=6}
## Aggression Attribute ----------------------------------------
hist(V(main_graph)$aggression, col="palegreen3",
     main="Figure 2a. Distribution of Group Aggression",
     xlab = "Aggression Attribute")

## Militia Attribute ----------------------------------------
hist(V(main_graph)$militia, col="palegreen3",
     main="Figure 2b. Distribution of Militia Status",
     xlab = "Militia Status")

## Subfaction Attribute ----------------------------------------
hist(V(main_graph)$subfaction, col="palegreen3",
     main="Figure 2c. Distribution of Subfaction Status",
     xlab = "Subfaction Status")

## Role Attribute ----------------------------------------
roles <- V(main_graph)$role
counts <- table(roles)

barplot(counts, col="palegreen3", width=0.5, cex.names = 0.6,
        names.arg = c("Jalisco NG", "Gulf Cartel", "Los Zetas", "Rising Challengers", "Sinaloa Cartel", 
                      "Small Cartels", "White Dwarfs"), 
        main = "Figure 2d. Distribution of Roles")

## Time Period Attribute ----------------------------------------
hist(E(main_graph)$period, col="palegreen3",
     main="Figure 2e. Distribution of Time Period",
     xlab = "Time Period (1=Pre-Arrest, 2=Post-Arrest)")
```


## Reproduction of Results from Colby (2021)

### Degree Distributions
Figures 3a-b show the replicated in-degree centrality distributions for the pre-arrest and post-arrest networks (Figure 2, row 1 in main analysis of Colby (2021)). In-degree is the number of incoming edges, and the distribution of that number increases after the arrest. 

```{r, fig.height=4, fig.width=6}
pre_in_degree <- igraph::degree(preNet, mode="in")
hist(pre_in_degree, breaks = 30, 
     main = "Figure 3a. In-Degree Centrality Distribution (Pre-Arrest)", 
     xlab = "In-Degree", col = "lightblue")

post_in_degree <- igraph::degree(postNet, mode="in")
hist(post_in_degree, breaks = 30, 
     main = "Figure 3b. In-Degree Centrality Distribution (Post-Arrest)", 
     xlab = "In-Degree", col = "lightblue")
```

Figures 4a-b show the replicated out-degree centrality distributions for the pre-arrest and post-arrest networks (Figure 2, row 2 in main analysis of Colby (2021)). Out-degree is the number of outgoing edges, with the number decreasing after the arrest. 

```{r, fig.height=4, fig.width=6}
pre_out_degree <- igraph::degree(preNet, mode="out")
hist(pre_out_degree, breaks = 30, 
     main = "Figure 4a. Out-Degree Centrality Distribution (Pre-Arrest)", 
     xlab = "Out-Degree", col = "lightblue")

post_out_degree <- igraph::degree(postNet, mode="out")
hist(post_out_degree, breaks = 30, 
     main = "Figure 4b. Out-Degree Centrality Distribution (Post-Arrest)", 
     xlab = "Out-Degree", col = "lightblue")
```

### SAOM Estimation
The main analysis of Colby (2021) includes estimating four stochastic actor oriented models (SAOM). Each of these estimates (1) alliances, (2) reputations, (3) strength, and (4) clustering of the cartels based on descriptive network statistics (similarity, assortativity, transitive closure, homophily, and reciprocity). The table below depicts these results, which show that (1) alliances had virtually no effect on cartels’ and militias’
decisions to fight one another; (2) after El Chapo’s arrest, cartels and militias faced greater reputational
costs for appearing weak, and; (3) El Chapo’s arrest did not greatly affect certainty about territorial control
and relative power of other cartels (p. 9). 

```{r}
# estimate_saom -----------------------------------------------------------

# Function to estimate a stochastic actor oriented model
# @Params: effect, the effect to estimate; seed, the seed to set the machine to
# @Returns: A sienaFit object
estimate_saom <- function(effect, seed){
   
   effect <- deparse(substitute(effect))
   
   # Create the basic data
   data <- sienaDataCreate(dv, aggression_var, subfaction_var, militia_var, 
                           role_var, joiners)
   
   # Effects for rate, reciprocity, and out-degree
   effects <- getEffects(data)
   
   # Effects for in-degree popularity, in-degree activity, out-degree popularity,
   # and balance. These reflect preferential attachment and similarity for outgoing 
   # ties between actors
   if (effect == "Jout") effects <- includeEffects(effects, Jout)
   if (effect == "inPop") effects <- includeEffects(effects, inPop)
   if (effect == "outInAss") effects <- includeEffects(effects, outInAss)
   if (effect == "transTrip1") effects <- includeEffects(effects, transTrip1)
   
   # Effects for homophily
   effects <- includeEffects(effects, sameX, interaction1 = "aggression_var")
   effects <- includeEffects(effects, sameX, interaction1 = "subfaction_var")
   effects <- includeEffects(effects, sameX, interaction1 = "militia_var")
   effects <- includeEffects(effects, sameX, interaction1 = "role_var")
   
   # Define algorithm and get results
   algorithm <- sienaAlgorithmCreate(projname = "output", seed = seed, 
                                     n3 = 3000, nsub = 7, firstg = 0.01)
   results <- siena07(algorithm, data = data, effects = effects, 
                      returnDeps = TRUE)
   
   # Check for convergence
   if (max(results$tstat > 1) | abs(results$tconv.max) > 0.25){
      
      results <- siena07(algorithm, data = data, effects = effects, 
                         returnDeps = TRUE, prevAns = results)
      
   }
   
   return(results)
   
}
```


```{r}
# Prepare the data for SAOM estimation ------------------------------------

# Make a graph with only edges in the first period
t0_network <- main_graph %>% 
   delete_edges(as.vector(E(postNet)))

# Make a graph with only edges in the second period
t1_network <- subgraph.edges(main_graph, as.vector(E(postNet)), 
                             delete.vertices = FALSE)

# Make a list for joiner nodes
joiner_nodes <- as_tibble(as.vector(V(t0_network)$name)) %>% 
                   mutate(node = row_number()) %>% 
                   ungroup() %>% 
                   relocate(node) %>% 
                   filter(!(value %in% as.vector(V(preNet)$name))) %>% 
                   pull(node)

# Make a list for all nodes and code them as being present in both periods
joiners <- rep(list(c(1, 2)), 151)

# Update periods for nodes that were only present in the second period
for (i in seq_along(joiners)){
   
   # Check to see if a node was a joiner in the second period
   if (i %in% joiner_nodes){
      
      # Recode the list to show joiners only in period 2
      joiners[[i]][1] <- 2
      
   }
   
}

# Creates an RSiena object for joiners
joiners <- sienaCompositionChange(joiners)

# Create a dependent variable
dv <- sienaDependent(array(c(as.matrix(as_adjacency_matrix(t0_network)), 
                             as.matrix(as_adjacency_matrix(main_graph))), 
                           dim = c(151, 151, 2)))

# Create constant covariates objects
role_var <- coCovar(as.vector(blocks$best$best1$clu))
militia_var <- coCovar(as.vector(V(main_graph)$militia))
aggression_var <- coCovar(as.vector(V(main_graph)$aggression))
subfaction_var <- coCovar(as.vector(V(main_graph)$subfaction))
```

```{r, message=FALSE, warning=FALSE, results='hide'}
# Run models with different effects ---------------------------------------

# Effects for Jaccard out-degree, in degree popularity, out-in-degree 
# assortativity, and transitive triples type 1
m1_results <- estimate_saom(Jout, 100)
m2_results <- estimate_saom(inPop, 200)
m3_results <- estimate_saom(outInAss, 300)
m4_results <- estimate_saom(transTrip1, 400)
```

### Table 1. SAOM Model Estimates - Replicated from Colby (2021)

```{r}
# Create a regression table -----------------------------------------------
screenreg(l = list(m1_results, m2_results, m3_results, m4_results),
        omit.coef = "basic rate parameter dv",
        custom.coef.map = list("out-Jaccard similarity" = "Jaccard Similarity",
                               "indegree - popularity" = "In-degree Popularity",
                               "out-in degree^(1/2) assortativity" 
                                     = "Out-in-degree Assortativity",
                               "transitive triplets (1)" = "Transitive Closure",
                               "same aggression_var" = "Aggression Homophily",
                               "same subfaction_var" = "Subfaction Homophily",
                               "same militia_var" = "Militia Homophily",
                               "same role_var" = "Role Homophily",
                               "reciprocity" = "Reciprocity"),
         custom.model.names = c("Alliances", "Reputation", "Strong-vs-weak",
                                "Clustering"),
         main = "Table 1. SAOM Model Estimates - Replicated from Colby (2021)")
```



